@using DubiRent.Data.Models
@model IEnumerable<ViewingRequest>
@{
    ViewData["Title"] = "My Viewing Requests";
    ViewData["Description"] = "View and manage your property viewing requests. Track the status of your requests and see upcoming appointments.";
    ViewData["Robots"] = "noindex, follow";
}

@section Styles {
    <link rel="stylesheet" href="~/css/my-viewing-requests.css" asp-append-version="true" />
}

<partial name="_Breadcrumb" />

<div class="my-viewing-requests-page">
<div class="container py-4" style="max-width: 1400px;">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="fw-bold mb-2" style="font-size: 2rem;">
                    <i class="fas fa-calendar-check me-2"></i>My Viewing Requests
                </h1>
                <p class="mb-0 opacity-90">Track and manage your property viewing requests</p>
            </div>
            <div class="text-end">
                <div class="d-flex align-items-baseline gap-2">
                    <h2 class="fw-bold mb-0" style="font-size: 2.5rem;">@(ViewBag.TotalCount ?? 0)</h2>
                    <span class="opacity-90" style="font-size: 1rem;">Total</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show rounded-3 shadow-sm mb-3" role="alert" style="border-left: 3px solid #10b981; padding: 0.625rem 1rem; font-size: 0.8125rem;">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show rounded-3 shadow-sm mb-3" role="alert" style="border-left: 3px solid #ef4444; padding: 0.625rem 1rem; font-size: 0.8125rem;">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Statistics Cards (Filter Buttons) -->
    @{
        var allRequests = ViewBag.AllRequests as IEnumerable<ViewingRequest> ?? Model ?? Enumerable.Empty<ViewingRequest>();
        var currentFilter = ViewBag.StatusFilter as string;
    }
    @if (allRequests.Any())
    {
        <div class="stats-grid">
            <a href="@Url.Action("MyViewingRequests", new { statusFilter = (string)null })" 
               class="stat-card @(string.IsNullOrEmpty(currentFilter) ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stat-value">@allRequests.Count()</div>
                <div class="stat-label">All</div>
            </a>
            <a href="@Url.Action("MyViewingRequests", new { statusFilter = "Pending" })" 
               class="stat-card @(currentFilter == "Pending" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Pending)</div>
                <div class="stat-label">Pending</div>
            </a>
            <a href="@Url.Action("MyViewingRequests", new { statusFilter = "Approved" })" 
               class="stat-card @(currentFilter == "Approved" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Approved)</div>
                <div class="stat-label">Approved</div>
            </a>
            <a href="@Url.Action("MyViewingRequests", new { statusFilter = "Completed" })" 
               class="stat-card @(currentFilter == "Completed" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Completed)</div>
                <div class="stat-label">Completed</div>
            </a>
            <a href="@Url.Action("MyViewingRequests", new { statusFilter = "Cancelled" })" 
               class="stat-card @(currentFilter == "Cancelled" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Cancelled)</div>
                <div class="stat-label">Cancelled</div>
            </a>
        </div>
    }

    <!-- Viewing Requests Grid -->
    @if (Model != null && Model.Any())
    {
        <div class="requests-grid">
            @foreach (var request in Model)
            {
                var mainImage = request.Property?.Images?.FirstOrDefault(img => img.IsMain) ?? request.Property?.Images?.FirstOrDefault();
                var imageUrl = mainImage != null ? mainImage.ImageUrl : "https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=400";

                <div class="request-card">
                    <!-- Property Image -->
                    <div class="property-image-wrapper">
                        <img src="@imageUrl" alt="@request.Property?.Title" class="property-image"
                             onerror="this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=400'" />
                    </div>

                    <!-- Status Badge -->
                    <span class="status-badge status-@request.Status.ToString().ToLower()">
                        @request.Status
                    </span>

                    <!-- Property Title -->
                    <h3 class="property-title">
                        <a asp-action="Details" asp-route-id="@request.PropertyId">
                            @request.Property?.Title
                        </a>
                    </h3>

                    <!-- Property Location -->
                    <div class="info-item mb-2">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>@request.Property?.Location?.Name, @request.Property?.Address</span>
                    </div>

                    <!-- Viewing Details -->
                    <div class="viewing-details">
                        <div class="info-label mb-2">
                            <i class="fas fa-calendar-alt me-1"></i>Viewing Details
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="info-label">Date</div>
                                <div class="info-value">@request.PreferredDate.ToString("MMM dd, yyyy")</div>
                            </div>
                            <div class="text-end">
                                <div class="info-label">Time</div>
                                <div class="info-value">
                                    @{
                                        var timeHour = request.PreferredTime.Hours;
                                        var timeMinute = request.PreferredTime.Minutes;
                                        var period = timeHour >= 12 ? "PM" : "AM";
                                        var displayHour = timeHour > 12 ? timeHour - 12 : (timeHour == 0 ? 12 : timeHour);
                                    }
                                    @displayHour.ToString("00"):@timeMinute.ToString("00") @period
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 pt-2" style="border-top: 1px solid #e5e7eb;">
                            <div class="info-label">Requested On</div>
                            <div class="info-value" style="font-size: 0.8125rem;">@request.CreatedAt.ToString("MMM dd, yyyy 'at' HH:mm")</div>
                        </div>
                    </div>

                    <!-- Property Info -->
                    <div class="d-flex gap-3 mb-3" style="font-size: 0.8125rem; color: #6b7280;">
                        <div class="info-item" style="margin-bottom: 0;">
                            <i class="fas fa-bed"></i>
                            <span>@request.Property?.Bedrooms Beds</span>
                        </div>
                        <div class="info-item" style="margin-bottom: 0;">
                            <i class="fas fa-bath"></i>
                            <span>@request.Property?.Bathrooms Baths</span>
                        </div>
                        <div class="info-item" style="margin-bottom: 0;">
                            <i class="fas fa-ruler-combined"></i>
                            <span>@request.Property?.SquareMeters mÂ²</span>
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="mb-3" style="border-top: 1px solid #f3f4f6; padding-top: 0.75rem;">
                        <div class="info-label mb-1">Price</div>
                        <div class="info-value" style="font-size: 1.25rem; color: #fe5658; font-weight: 700;">
                            $@request.Property?.PricePerMonth.ToString("N0") <span style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">/month</span>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <a asp-action="Details" asp-route-id="@request.PropertyId" class="btn-view-property">
                        <i class="fas fa-eye"></i>
                        <span>View Property</span>
                    </a>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h4 class="fw-bold mb-2" style="font-size: 1.5rem; color: #1f2937;">No Viewing Requests</h4>
            <p class="text-muted mb-4" style="font-size: 1rem;">
                @if (!string.IsNullOrEmpty(currentFilter))
                {
                    <span>You don't have any @currentFilter.ToLower() viewing requests.</span>
                }
                else
                {
                    <span>You haven't submitted any viewing requests yet.</span>
                }
            </p>
            <a asp-action="Properties" class="btn-view-property" style="width: auto; padding: 0.75rem 2rem; display: inline-flex;">
                <i class="fas fa-search"></i>
                <span>Browse Properties</span>
            </a>
        </div>
    }
</div>
</div>

