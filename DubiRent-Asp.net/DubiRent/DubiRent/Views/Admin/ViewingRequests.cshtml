@using DubiRent.Data.Models
@model IEnumerable<ViewingRequest>
@{
    ViewData["Title"] = "Viewing Requests";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-viewing-requests.css" asp-append-version="true" />
}

<div class="container-fluid py-3 admin-viewing-requests-page" style="max-width: 1400px;">
    <partial name="_Breadcrumb" />
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1 class="fw-bold mb-1" style="font-size: 1.5rem;">Viewing Requests</h1>
                <p class="mb-0 opacity-90" style="font-size: 0.8125rem;">Manage all property viewing requests</p>
            </div>
            <div class="text-end">
                <div class="d-flex align-items-baseline gap-2">
                    <h2 class="fw-bold mb-0" style="font-size: 1.75rem;">@(Model?.Count() ?? 0)</h2>
                    <span class="opacity-90" style="font-size: 0.8125rem;">Total</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show rounded-3 shadow-sm mb-3" role="alert" style="border-left: 3px solid #10b981; padding: 0.625rem 1rem; font-size: 0.8125rem;">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show rounded-3 shadow-sm mb-3" role="alert" style="border-left: 3px solid #ef4444; padding: 0.625rem 1rem; font-size: 0.8125rem;">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Statistics Cards (Filter Buttons) -->
    @{
        var allRequests = ViewBag.AllRequests as IEnumerable<ViewingRequest> ?? Model ?? Enumerable.Empty<ViewingRequest>();
        var currentFilter = ViewBag.StatusFilter as string;
    }
    @if (allRequests.Any())
    {
        <div class="stats-grid">
            <a href="@Url.Action("ViewingRequests", new { statusFilter = (string)null })" 
               class="stat-card @(string.IsNullOrEmpty(currentFilter) ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stat-value">@allRequests.Count()</div>
                <div class="stat-label">All</div>
            </a>
            <a href="@Url.Action("ViewingRequests", new { statusFilter = "Pending" })" 
               class="stat-card @(currentFilter == "Pending" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Pending)</div>
                <div class="stat-label">Pending</div>
            </a>
            <a href="@Url.Action("ViewingRequests", new { statusFilter = "Approved" })" 
               class="stat-card @(currentFilter == "Approved" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Approved)</div>
                <div class="stat-label">Approved</div>
            </a>
            <a href="@Url.Action("ViewingRequests", new { statusFilter = "Completed" })" 
               class="stat-card @(currentFilter == "Completed" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-check-double"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Completed)</div>
                <div class="stat-label">Completed</div>
            </a>
            <a href="@Url.Action("ViewingRequests", new { statusFilter = "Cancelled" })" 
               class="stat-card @(currentFilter == "Cancelled" ? "active" : "")">
                <div class="stat-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-value">@allRequests.Count(r => r.Status == ViewingRequestStatus.Cancelled)</div>
                <div class="stat-label">Cancelled</div>
            </a>
        </div>
    }

    <!-- Viewing Requests Grid -->
    @if (Model != null && Model.Any())
    {
        <div class="requests-grid">
            @foreach (var request in Model)
            {
                var mainImage = request.Property?.Images?.FirstOrDefault(img => img.IsMain) ?? request.Property?.Images?.FirstOrDefault();
                var imageUrl = mainImage != null ? mainImage.ImageUrl : "https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=200";

                <div class="request-card">
                    <!-- Property Image & Title -->
                    <div class="d-flex align-items-start gap-2 mb-3">
                        <div class="property-image-wrapper" style="width: 80px; height: 80px; flex-shrink: 0;">
                            <img src="@imageUrl" alt="@request.Property?.Title" class="property-image"
                                 onerror="this.src='https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=200'" />
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h6 class="fw-bold mb-1" style="font-size: 0.9375rem; color: #1f2937; line-height: 1.3;">
                                @request.Property?.Title
                            </h6>
                            <p class="mb-0 info-item" style="font-size: 0.8125rem;">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>@request.Property?.Location?.Name</span>
                            </p>
                        </div>
                        <span class="status-badge status-@request.Status.ToString().ToLower()" style="align-self: flex-start;">
                            @request.Status
                        </span>
                    </div>

                    <!-- Contact Info -->
                    <div class="mb-3" style="border-top: 1px solid #f3f4f6; border-bottom: 1px solid #f3f4f6; padding: 0.75rem 0;">
                        <div class="mb-2">
                            <div class="info-label">
                                <i class="fas fa-user me-1"></i>Name
                            </div>
                            <div class="info-value" style="font-size: 0.875rem;">@request.FullName</div>
                        </div>
                        <div class="mb-2">
                            <div class="info-label">
                                <i class="fas fa-phone me-1"></i>Phone
                            </div>
                            <a href="tel:@request.PhoneNumber" class="info-value contact-link" style="font-size: 0.875rem;">@request.PhoneNumber</a>
                        </div>
                        <div>
                            <div class="info-label">
                                <i class="fas fa-envelope me-1"></i>Email
                            </div>
                            <a href="mailto:@request.Email" class="info-value contact-link" style="font-size: 0.8125rem; word-break: break-word;">@request.Email</a>
                        </div>
                    </div>

                    <!-- Viewing Details -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="info-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Date
                                </div>
                                <div class="info-value" style="font-size: 0.875rem;">@request.PreferredDate.ToString("MMM dd, yyyy")</div>
                            </div>
                            <div class="text-end">
                                <div class="info-label">
                                    <i class="fas fa-clock me-1"></i>Time
                                </div>
                                <div class="info-value" style="font-size: 0.875rem;">@request.PreferredTime.ToString(@"hh\:mm")</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-2 flex-wrap mt-auto">
                        <a asp-controller="Property" asp-action="Details" asp-route-id="@request.PropertyId" class="action-btn btn-view" style="flex: 1; justify-content: center;">
                            <i class="fas fa-eye"></i>
                            <span>View Property</span>
                        </a>
                        @if (request.Status == ViewingRequestStatus.Pending)
                        {
                            <form asp-action="UpdateRequestStatus" method="post" class="approve-form" style="display: inline; flex: 1;" novalidate data-request-id="@request.Id">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@request.Id" />
                                <input type="hidden" name="status" value="@((int)ViewingRequestStatus.Approved)" />
                                <button type="submit" class="action-btn btn-approve w-100" title="Approve" style="justify-content: center;">
                                    <i class="fas fa-check"></i>
                                    <span>Approve</span>
                                </button>
                            </form>
                            <button type="button" class="action-btn btn-cancel" title="Cancel" data-bs-toggle="modal" data-bs-target="#cancelRequestModal" data-request-id="@request.Id" data-property-title="@request.Property?.Title" data-request-date="@request.PreferredDate.ToString("MMM dd, yyyy")" style="flex: 1; justify-content: center;">
                                <i class="fas fa-times"></i>
                                <span>Cancel</span>
                            </button>
                        }
                        else if (request.Status == ViewingRequestStatus.Approved)
                        {
                            <form asp-action="UpdateRequestStatus" method="post" class="approve-form" style="display: inline; flex: 1;" novalidate>
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@request.Id" />
                                <input type="hidden" name="status" value="@((int)ViewingRequestStatus.Completed)" />
                                <button type="submit" class="action-btn btn-complete w-100" title="Mark Complete" style="justify-content: center;">
                                    <i class="fas fa-check-double"></i>
                                    <span>Complete</span>
                                </button>
                            </form>
                            <button type="button" class="action-btn btn-cancel" title="Cancel" data-bs-toggle="modal" data-bs-target="#cancelRequestModal" data-request-id="@request.Id" data-property-title="@request.Property?.Title" data-request-date="@request.PreferredDate.ToString("MMM dd, yyyy")" style="flex: 1; justify-content: center;">
                                <i class="fas fa-times"></i>
                                <span>Cancel</span>
                            </button>
                        }
                        else if (request.Status == ViewingRequestStatus.Cancelled)
                        {
                            <form asp-action="UpdateRequestStatus" method="post" class="approve-form" style="display: inline; flex: 1;" novalidate>
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@request.Id" />
                                <input type="hidden" name="status" value="@((int)ViewingRequestStatus.Approved)" />
                                <button type="submit" class="action-btn btn-approve w-100" title="Approve" style="justify-content: center;">
                                    <i class="fas fa-check"></i>
                                    <span>Approve</span>
                                </button>
                            </form>
                            <form asp-action="UpdateRequestStatus" method="post" class="approve-form" style="display: inline; flex: 1;" novalidate>
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@request.Id" />
                                <input type="hidden" name="status" value="@((int)ViewingRequestStatus.Pending)" />
                                <button type="submit" class="action-btn btn-secondary w-100" title="Reset to Pending" style="justify-content: center; background: #6b7280; color: white;">
                                    <i class="fas fa-undo"></i>
                                    <span>Reset</span>
                                </button>
                            </form>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h4 class="fw-bold mb-2" style="font-size: 1.125rem; color: #1f2937;">No Viewing Requests</h4>
            <p class="text-muted mb-0" style="font-size: 0.875rem;">There are no viewing requests at the moment.</p>
        </div>
    }
</div>

<!-- Cancel Request Confirmation Modal -->
<div class="modal fade" id="cancelRequestModal" tabindex="-1" aria-labelledby="cancelRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div class="modal-header border-0 pb-0" style="padding: 2rem 2rem 1rem;">
                <div class="modal-icon-wrapper d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 80px; height: 80px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-radius: 50%;">
                    <i class="fas fa-exclamation-triangle text-danger" style="font-size: 2.5rem;"></i>
                </div>
            </div>
            <div class="modal-body text-center px-4 pb-0" style="padding: 0 2rem 1.5rem;">
                <h5 class="modal-title fw-bold mb-3" id="cancelRequestModalLabel" style="font-size: 1.5rem; color: #1f2937;">
                    Cancel Viewing Request?
                </h5>
                <p class="text-muted mb-4" style="font-size: 0.9375rem; line-height: 1.6;">
                    Are you sure you want to cancel the viewing request for <strong class="text-dark" id="requestPropertyTitle"></strong> scheduled on <strong class="text-dark" id="requestDate"></strong>?
                </p>
                <div class="alert alert-warning d-flex align-items-start mb-4" style="border-radius: 10px; background: #fff7ed; border: 1px solid #fed7aa; color: #9a3412;">
                    <i class="fas fa-info-circle me-2 mt-1"></i>
                    <div class="text-start" style="font-size: 0.875rem;">
                        <strong>Warning:</strong> This action will mark the viewing request as cancelled. The status change can be seen by all parties.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0 justify-content-center gap-3" style="padding: 0 2rem 2rem;">
                <button type="button" class="btn btn-light px-4 py-2" data-bs-dismiss="modal" style="border-radius: 10px; border: 1px solid #e5e7eb; font-weight: 600;">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <form id="cancelRequestForm" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="status" value="@((int)ViewingRequestStatus.Cancelled)" />
                    <button type="submit" class="btn btn-danger px-4 py-2" style="border-radius: 10px; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">
                        <i class="fas fa-times-circle me-2"></i><span class="btn-text">Cancel Request</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); background: transparent;">
            <div class="modal-body text-center" style="padding: 3rem;">
                <div class="spinner-border text-success" role="status" style="width: 4rem; height: 4rem; border-width: 0.4rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-4 fw-bold" style="color: white; font-size: 1.25rem;">Processing Request...</h5>
                <p class="text-white-50 mb-0 mt-2" style="font-size: 0.9375rem;">Please wait while we approve the viewing request</p>
            </div>
        </div>
    </div>
</div>
</div>

@section Scripts {
    <script src="~/js/admin-viewing-requests.js" asp-append-version="true"></script>
    <script>
        // Set the UpdateRequestStatus URL for the cancel form
        document.addEventListener('DOMContentLoaded', function() {
            var cancelForm = document.getElementById('cancelRequestForm');
            if (cancelForm) {
                cancelForm.setAttribute('data-action-url', '@Url.Action("UpdateRequestStatus", "Admin")');
            }
        });
    </script>
}
