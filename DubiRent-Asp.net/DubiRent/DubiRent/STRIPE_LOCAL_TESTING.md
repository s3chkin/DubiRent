# Ð¢ÐµÑÑ‚Ð²Ð°Ð½Ðµ Ð½Ð° Stripe Ð›Ð¾ÐºÐ°Ð»Ð½Ð¾ (Ð‘ÐµÐ· ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐ²Ð°Ð½Ðµ)

## âœ… ÐÐ• Ð• ÐÐ£Ð–ÐÐž Ð¡ÐÐ™Ð¢ÐªÐ¢ Ð”Ð Ð• ÐŸÐ£Ð‘Ð›Ð˜ÐšÐ£Ð’ÐÐ!

ÐœÐ¾Ð¶ÐµÑ‚Ðµ Ð´Ð° Ñ‚ÐµÑÑ‚Ð²Ð°Ñ‚Ðµ Ñ†ÑÐ»Ð°Ñ‚Ð° Stripe Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð»Ð¾ÐºÐ°Ð»Ð½Ð¾ Ð±ÐµÐ· Ð´Ð° Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐ²Ð°Ñ‚Ðµ ÑÐ°Ð¹Ñ‚Ð°.

## Ð¡Ñ‚ÑŠÐ¿ÐºÐ¸ Ð·Ð° Ð›Ð¾ÐºÐ°Ð»Ð½Ð¾ Ð¢ÐµÑÑ‚Ð²Ð°Ð½Ðµ

### 1. ÐŸÐ¾Ð»ÑƒÑ‡ÐµÑ‚Ðµ Test API ÐšÐ»ÑŽÑ‡Ð¾Ð²Ðµ

1. ÐžÑ‚Ð¸Ð´ÐµÑ‚Ðµ Ð½Ð° [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys)
2. Ð£Ð²ÐµÑ€ÐµÑ‚Ðµ ÑÐµ, Ñ‡Ðµ ÑÑ‚Ðµ Ð² **Test mode** (Ñ‚ÑƒÐ¼Ð±Ð»ÐµÑ€ÑŠÑ‚ Ð² Ð³Ð¾Ñ€Ð½Ð¸Ñ Ð´ÐµÑÐµÐ½ ÑŠÐ³ÑŠÐ»)
3. ÐšÐ¾Ð¿Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ:
   - **Publishable key** (`pk_test_...`)
   - **Secret key** (`sk_test_...`)

### 2. ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ appsettings.json

Ð”Ð¾Ð±Ð°Ð²ÐµÑ‚Ðµ Ð² `appsettings.json`:

```json
"Stripe": {
  "PublishableKey": "pk_test_YOUR_PUBLISHABLE_KEY",
  "SecretKey": "sk_test_YOUR_SECRET_KEY",
  "WebhookSecret": "whsec_PLACEHOLDER"
}
```

### 3. Ð˜Ð½ÑÑ‚Ð°Ð»Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Stripe CLI (Ð—Ð° Webhooks)

**Ð’Ð¸Ð¶ Ð´ÐµÑ‚Ð°Ð¹Ð»Ð½Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð²: `INSTALL_STRIPE_CLI.md`**

**Ð‘ÑŠÑ€Ð·Ð° Ð¸Ð½ÑÑ‚Ð°Ð»Ð°Ñ†Ð¸Ñ:**

1. **Ð Ð°Ð·Ñ€ÐµÑˆÐ¸ PowerShell ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ðµ:**

   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
   ```

2. **Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð°Ñ‚Ð° Ð¸Ð½ÑÑ‚Ð°Ð»Ð°Ñ†Ð¸Ñ:**
   ```powershell
   cd DubiRent
   .\install-stripe-cli.ps1
   ```

**ÐÐ»Ñ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð° - Ð ÑŠÑ‡Ð½Ð° Ð¸Ð½ÑÑ‚Ð°Ð»Ð°Ñ†Ð¸Ñ:**

- Ð¡Ð²Ð°Ð»Ð¸ Ð¾Ñ‚: https://github.com/stripe/stripe-cli/releases/latest
- Ð˜Ð½ÑÑ‚Ð°Ð»Ð¸Ñ€Ð°Ð¹ `.msi` Ñ„Ð°Ð¹Ð»Ð°
- Ð ÐµÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð¹ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ð°

### 4. Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ ÑÐµ Ñ Stripe CLI

```bash
stripe login
```

Ð¡Ð»ÐµÐ´Ð²Ð°Ð¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸Ñ‚Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÑŠÑ€Ð°.

### 5. Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Stripe Webhook Listener

**ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ (Ð¸Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°):**

```powershell
cd DubiRent
.\start-stripe-webhook.ps1
```

**Ð˜Ð»Ð¸ Ñ€ÑŠÑ‡Ð½Ð¾ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÐµÐ½ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»:**

```powershell
stripe listen --forward-to https://localhost:5001/Payment/Webhook
```

**Ð’Ð°Ð¶Ð½Ð¾:** Ð˜Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð½Ð¸Ñ Ð¿Ð¾Ñ€Ñ‚ (5001 Ð·Ð° HTTPS Ð¸Ð»Ð¸ 5000 Ð·Ð° HTTP)

CLI Ñ‰Ðµ Ð¿Ð¾ÐºÐ°Ð¶Ðµ Ð½ÐµÑ‰Ð¾ ÐºÐ°Ñ‚Ð¾:

```
> Ready! Your webhook signing secret is whsec_xxxxxxxxxxxxx
```

### 6. ÐšÐ¾Ð¿Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Webhook Secret

ÐšÐ¾Ð¿Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½Ð¸Ñ `whsec_...` secret Ð¸ Ð¾Ð±Ð½Ð¾Ð²ÐµÑ‚Ðµ `appsettings.json`:

```json
"Stripe": {
  "PublishableKey": "pk_test_...",
  "SecretKey": "sk_test_...",
  "WebhookSecret": "whsec_xxxxxxxxxxxxx"  // â† Ð¢Ð¾Ð·Ð¸ Ð¾Ñ‚ CLI
}
```

### 7. Ð¡Ñ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÑ‚Ð¾

```bash
dotnet run
```

### 8. Ð¢ÐµÑÑ‚Ð²Ð°Ð¹Ñ‚Ðµ ÐŸÐ»Ð°Ñ‰Ð°Ð½ÐµÑ‚Ð¾

1. ÐžÑ‚Ð²Ð¾Ñ€ÐµÑ‚Ðµ Ð±Ñ€Ð°ÑƒÐ·ÑŠÑ€: `https://localhost:5001`
2. Ð›Ð¾Ð³Ð½ÐµÑ‚Ðµ ÑÐµ (Ð¸Ð»Ð¸ ÑÑŠÐ·Ð´Ð°Ð¹Ñ‚Ðµ Ð°ÐºÐ°ÑƒÐ½Ñ‚)
3. ÐžÑ‚Ð¸Ð´ÐµÑ‚Ðµ Ð½Ð° Ð´ÐµÑ‚Ð°Ð¹Ð»Ð¸Ñ‚Ðµ Ð½Ð° Ð¸Ð¼Ð¾Ñ‚
4. ÐšÐ»Ð¸ÐºÐ½ÐµÑ‚Ðµ **"Pay with Stripe"**
5. Ð‘Ñ€Ð°ÑƒÐ·ÑŠÑ€ÑŠÑ‚ Ñ‰Ðµ ÑÐµ Ð¿Ñ€ÐµÐ½Ð°ÑÐ¾Ñ‡Ð¸ ÐºÑŠÐ¼ Stripe Checkout (Ñ€Ð°Ð±Ð¾Ñ‚Ð¸ Ð¿ÐµÑ€Ñ„ÐµÐºÑ‚Ð½Ð¾ Ð½Ð° localhost!)
6. Ð’ÑŠÐ²ÐµÐ´ÐµÑ‚Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð° ÐºÐ°Ñ€Ñ‚Ð°: `4242 4242 4242 4242`
7. Expiry: `12/25`
8. CVC: `123`
9. ZIP: `12345`
10. ÐšÐ»Ð¸ÐºÐ½ÐµÑ‚Ðµ **"Pay"**
11. Ð©Ðµ ÑÐµ Ð²ÑŠÑ€Ð½ÐµÑ‚Ðµ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð½Ð° ÑÐ°Ð¹Ñ‚Ð° Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð»Ð°Ñ‰Ð°Ð½Ðµ!

### 9. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐµÑ‚Ðµ Webhook Events

Ð’ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ð° ÐºÑŠÐ´ÐµÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð¸ `stripe listen` Ñ‰Ðµ Ð²Ð¸Ð´Ð¸Ñ‚Ðµ Ð²ÑÐ¸Ñ‡ÐºÐ¸ webhook events:

```
2025-01-06 15:30:45 --> checkout.session.completed [evt_xxx]
2025-01-06 15:30:45 <-- [200] POST https://localhost:5001/Payment/Webhook
```

## âš ï¸ Ð’Ð°Ð¶Ð½Ð¾

- **Checkout Ñ€Ð°Ð±Ð¾Ñ‚Ð¸ Ð½Ð° localhost** - Stripe Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð¿Ñ€ÐµÐ½Ð°ÑÐ¾Ñ‡Ð²Ð° Ð¸ Ð²Ñ€ÑŠÑ‰Ð° Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾
- **Webhooks Ð¸Ð·Ð¸ÑÐºÐ²Ð°Ñ‚ HTTPS** - Ð¸Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ð¹Ñ‚Ðµ `https://localhost:5001`
- **Ð—Ð° production** Ñ‰Ðµ Ñ‚Ñ€ÑÐ±Ð²Ð° Ð´Ð° Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ webhook URL Ð² Stripe Dashboard

## Ð‘ÐµÐ· Stripe CLI (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»Ð½Ð¾)

ÐÐºÐ¾ Ð½Ðµ Ð¸ÑÐºÐ°Ñ‚Ðµ Ð´Ð° Ð¸Ð½ÑÑ‚Ð°Ð»Ð¸Ñ€Ð°Ñ‚Ðµ Stripe CLI:

1. ÐŸÐ»Ð°Ñ‰Ð°Ð½Ð¸ÑÑ‚Ð° Ñ‰Ðµ Ñ€Ð°Ð±Ð¾Ñ‚ÑÑ‚
2. ÐÐ¾ webhook events Ð½ÑÐ¼Ð° Ð´Ð° Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð³Ð°Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾
3. ÐœÐ¾Ð¶Ðµ Ñ€ÑŠÑ‡Ð½Ð¾ Ð´Ð° Ð¾Ð±Ð½Ð¾Ð²ÑÐ²Ð°Ñ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¸Ñ‚Ðµ Ð² Ð±Ð°Ð·Ð°Ñ‚Ð° Ð´Ð°Ð½Ð½Ð¸
4. Ð˜Ð»Ð¸ Ð´Ð° Ð¸Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ñ‚Ðµ Stripe Dashboard â†’ Payments â†’ Manual webhook trigger

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÐŸÐ»Ð°Ñ‰Ð°Ð½Ð¸ÑÑ‚Ð°

1. Ð’ Stripe Dashboard â†’ **Payments** Ñ‰Ðµ Ð²Ð¸Ð´Ð¸Ñ‚Ðµ Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¸ Ð¿Ð»Ð°Ñ‰Ð°Ð½Ð¸Ñ
2. Ð’ Ð±Ð°Ð·Ð°Ñ‚Ð° Ð´Ð°Ð½Ð½Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ñ‚Ð° `Payments` Ñ‰Ðµ ÑÑŠÐ´ÑŠÑ€Ð¶Ð° Ð·Ð°Ð¿Ð¸ÑÐ¸Ñ‚Ðµ
3. Ð’ Ð´ÐµÑ‚Ð°Ð¹Ð»Ð¸Ñ‚Ðµ Ð½Ð° Ð¸Ð¼Ð¾Ñ‚ Ñ‰Ðµ Ð²Ð¸Ð´Ð¸Ñ‚Ðµ "Payment Completed" Ð²Ð¼ÐµÑÑ‚Ð¾ Ð±ÑƒÑ‚Ð¾Ð½

## Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ðŸŽ‰

ÐœÐ¾Ð¶ÐµÑ‚Ðµ Ð´Ð° Ñ‚ÐµÑÑ‚Ð²Ð°Ñ‚Ðµ Ñ†ÑÐ»Ð°Ñ‚Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»Ð½Ð¾ÑÑ‚ Ð»Ð¾ÐºÐ°Ð»Ð½Ð¾ Ð±ÐµÐ· Ð´Ð° Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐ²Ð°Ñ‚Ðµ ÑÐ°Ð¹Ñ‚Ð°!
